import { Button, VerticalBox, HorizontalBox, ScrollView, GridBox, TextEdit, Slider } from "std-widgets.slint";

export struct SampleInfo {
    slot: int,
    name: string,
    length: int,
    speed: int,
    has-sample: bool,
}

// Waveform viewer component
component WaveformView inherits Rectangle {
    in property <string> sample-name: "No sample selected";
    in property <int> sample-length: 0;
    in property <string> waveform-path: "";  // SVG path commands for waveform
    in property <bool> has-waveform: false;
    in property <bool> is-playing: false;
    in property <float> playback-position: 0.0;  // 0.0 to 1.0
    in-out property <float> zoom-level: 1.0;
    in-out property <float> scroll-position: 0.0;

    // Track display dimensions for waveform regeneration
    in-out property <length> waveform-display-width;
    in-out property <length> waveform-display-height;

    callback regenerate-waveform(/* width */ float, /* height */ float);

    callback zoom-in();
    callback zoom-out();
    callback zoom-reset();

    border-radius: 4px;
    border-width: 1px;
    border-color: #cccccc;
    background: #1a1a2e;

    VerticalLayout {
        padding: 8px;
        spacing: 4px;

        // Header with sample info and zoom controls
        HorizontalLayout {
            height: 24px;
            spacing: 8px;

            Text {
                text: sample-name;
                font-size: 12px;
                font-weight: 600;
                color: #ffffff;
                vertical-alignment: center;
            }

            Rectangle { horizontal-stretch: 1; }

            Text {
                text: "Zoom: " + round(zoom-level * 100) + "%";
                font-size: 10px;
                color: #888888;
                vertical-alignment: center;
            }

            Button {
                text: "âˆ’";
                width: 28px;
                clicked => { zoom-out(); }
            }

            Button {
                text: "+";
                width: 28px;
                clicked => { zoom-in(); }
            }

            Button {
                text: "Reset";
                clicked => { zoom-reset(); }
            }
        }

        // Waveform display area
        waveform-display-area := Rectangle {
            vertical-stretch: 1;
            background: #0d0d1a;
            border-radius: 2px;
            clip: true;

            // Track display dimensions and trigger regeneration when they change
            changed width => {
                root.waveform-display-width = self.width;
                root.waveform-display-height = self.height;
                root.regenerate-waveform(self.width / 1px, self.height / 1px);
            }
            changed height => {
                root.waveform-display-width = self.width;
                root.waveform-display-height = self.height;
                root.regenerate-waveform(self.width / 1px, self.height / 1px);
            }

            // Grid lines
            // Horizontal center line (zero crossing)
            Rectangle {
                x: 0;
                y: parent.height / 2 - 0.5px;
                width: parent.width;
                height: 1px;
                background: #333355;
            }

            // Top quarter line
            Rectangle {
                x: 0;
                y: parent.height / 4;
                width: parent.width;
                height: 1px;
                background: #222244;
            }

            // Bottom quarter line
            Rectangle {
                x: 0;
                y: parent.height * 3 / 4;
                width: parent.width;
                height: 1px;
                background: #222244;
            }

            // Vertical grid lines (time markers)
            for i in [1, 2, 3, 4, 5, 6, 7, 8, 9]: Rectangle {
                x: parent.width * i / 10;
                y: 0;
                width: 1px;
                height: parent.height;
                background: #222244;
            }

            // "No waveform" message when empty
            if !has-waveform: Text {
                text: "Click a sample pad to view its waveform";
                font-size: 12px;
                color: #666688;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            // Waveform path rendered from SVG commands (filled envelope)
            // Viewbox matches parent dimensions for proper scaling
            if has-waveform: Path {
                x: 0;
                y: 0;
                width: parent.width;
                height: parent.height;
                commands: waveform-path;
                fill: #4a90e2;
                stroke: #6ab0ff;
                stroke-width: 0.5px;
                viewbox-x: scroll-position * (parent.width / 1px);
                viewbox-y: 0;
                viewbox-width: (parent.width / 1px) / zoom-level;
                viewbox-height: parent.height / 1px;
            }

            // Playhead indicator (only visible during playback with waveform)
            if is-playing && has-waveform: Rectangle {
                x: (playback-position - scroll-position) * zoom-level * parent.width;
                y: 0;
                width: 2px;
                height: parent.height;
                background: #ff6b6b;
            }

            // Y-axis labels
            Text {
                x: 4px;
                y: 2px;
                text: "+1.0";
                font-size: 8px;
                color: #444466;
            }

            Text {
                x: 4px;
                y: parent.height / 2 - 6px;
                text: "0.0";
                font-size: 8px;
                color: #444466;
            }

            Text {
                x: 4px;
                y: parent.height - 12px;
                text: "-1.0";
                font-size: 8px;
                color: #444466;
            }
        }

        // Scroll bar / position indicator
        if has-waveform: HorizontalLayout {
            height: 20px;
            spacing: 8px;
            alignment: center;

            Text {
                text: "Position:";
                font-size: 10px;
                color: #666666;
                vertical-alignment: center;
            }

            Slider {
                horizontal-stretch: 1;
                minimum: 0;
                maximum: 1.0 - (1.0 / zoom-level);
                value <=> scroll-position;
                enabled: zoom-level > 1.0;
            }

            Text {
                text: round(scroll-position * 100) + "%";
                font-size: 10px;
                color: #666666;
                vertical-alignment: center;
                width: 40px;
            }
        }
    }
}

component SamplePad inherits Rectangle {
    in property <SampleInfo> sample;
    in property <bool> selected: false;
    callback upload-clicked();
    callback download-clicked();
    callback delete-clicked();
    callback pad-clicked();

    border-radius: 8px;
    border-width: selected ? 3px : 2px;
    border-color: selected ? #ff9800 : (sample.has-sample ? #4a90e2 : #cccccc);
    background: sample.has-sample ? #f0f8ff : #f9f9f9;

    // Make the whole pad clickable
    TouchArea {
        clicked => { pad-clicked(); }
    }

    VerticalLayout {
        padding: 8px;
        spacing: 3px;
        alignment: stretch;

        // Slot number
        Text {
            text: sample.slot < 10 ? "00" + sample.slot : (sample.slot < 100 ? "0" + sample.slot : "" + sample.slot);
            font-size: 13px;
            font-weight: 700;
            color: #666;
            horizontal-alignment: center;
        }

        // Sample name or empty indicator
        Text {
            text: sample.has-sample ? sample.name : "(empty)";
            font-size: 11px;
            font-weight: sample.has-sample ? 600 : 400;
            color: sample.has-sample ? #333 : #999;
            overflow: elide;
            horizontal-alignment: center;
        }

        // Length display (rounded to 1 decimal place)
        if sample.has-sample: Text {
            text: round(sample.length / 3125.0) / 10.0 + "s";
            font-size: 10px;
            color: #666;
            horizontal-alignment: center;
        }

        // Sample rate display in kHz
        if sample.has-sample: Text {
            text: Math.mod(round(31.25 * sample.speed / 16384.0 * 100), 100) == 0
                    ? round(31.25 * sample.speed / 16384.0) + " kHz"
                    : round(31.25 * sample.speed / 16384.0 * 100) / 100 + " kHz";
            font-size: 9px;
            color: #888;
            horizontal-alignment: center;
        }

        // Spacer - pushes buttons to bottom
        Rectangle {
            vertical-stretch: 1;
        }

        // Action buttons - anchored at bottom
        HorizontalLayout {
            spacing: 4px;
            alignment: center;

            if sample.has-sample: Button {
                text: "ðŸ’¾";
                clicked => { download-clicked(); }
            }

            if !sample.has-sample: Button {
                text: "â¬†";
                clicked => { upload-clicked(); }
            }

            if sample.has-sample: Button {
                text: "ðŸ—‘";
                clicked => { delete-clicked(); }
            }
        }
    }
}

export component AppWindow inherits Window {
    title: "Volca Sample 2 Manager";
    preferred-width: 800px;
    preferred-height: show-debug-log ? 680px : 540px;
    min-width: 800px;
    min-height: show-debug-log ? 680px : 540px;
    default-font-family: "SF Mono";

    callback connect-clicked();
    callback refresh-clicked();
    callback upload-clicked(int);
    callback download-clicked(int);
    callback delete-clicked(int);
    callback prev-page-clicked();
    callback next-page-clicked();
    callback toggle-debug-log();
    callback pad-selected(int);
    callback waveform-zoom-in();
    callback waveform-zoom-out();
    callback waveform-zoom-reset();
    callback regenerate-waveform(float, float);
    callback play-clicked();
    callback stop-clicked();

    in-out property <bool> connected: false;
    in-out property <[SampleInfo]> samples;
    in-out property <[string]> logs;
    in-out property <string> log-text;
    in-out property <int> current-page: 0;
    in-out property <int> total-pages: 20; // 200 slots / 10 per page = 20 pages
    in-out property <bool> scanning: false;
    in-out property <bool> show-debug-log: false;

    // Waveform viewer state
    in-out property <int> selected-slot: -1;
    in-out property <string> selected-sample-name: "No sample selected";
    in-out property <int> selected-sample-length: 0;
    in-out property <string> waveform-path: "";  // SVG path commands
    in-out property <float> waveform-zoom: 1.0;
    in-out property <float> waveform-scroll: 0.0;
    in-out property <bool> is-playing: false;
    in-out property <length> waveform-display-width;
    in-out property <length> waveform-display-height;
    in-out property <float> playback-position: 0.0;  // 0.0 to 1.0

    // Calculate which samples to display (10 per page - 5x2 grid)
    property <int> start-slot: current-page * 10;

    FocusScope {
        init => { self.focus(); }

        key-pressed(event) => {
            if ((event.modifiers.meta || event.modifiers.control) && event.text == "d") {
                toggle-debug-log();
                return accept;
            }
            return reject;
        }

        VerticalLayout {
            padding: 12px;
            spacing: 8px;

            // Connection bar
            HorizontalBox {
                height: 32px;
                spacing: 12px;

                Rectangle {
                    width: 10px;
                    height: 10px;
                    border-radius: 5px;
                    background: connected ? #4caf50 : #f44336;
                }

                Text {
                    text: connected ? (scanning ? "Connected - Scanning..." : "Connected to Volca Sample 2") : "Not Connected";
                    font-size: 14px;
                    font-weight: 600;
                    vertical-alignment: center;
                }

                Rectangle {
                    horizontal-stretch: 1;
                }

                Button {
                    text: connected ? "Disconnect" : "Connect";
                    clicked => { connect-clicked(); }
                }

                Button {
                    text: "Scan";
                    clicked => { refresh-clicked(); }
                    enabled: connected && !scanning;
                }
            }

            // Page navigation
            HorizontalBox {
                height: 28px;
                spacing: 8px;
                alignment: center;

                Button {
                    text: "â—€";
                    clicked => { prev-page-clicked(); }
                    enabled: current-page > 0;
                }

                Text {
                    text: "Page " + (current-page + 1) + "/" + total-pages + " (Slots " + start-slot + "-" + (start-slot + 9) + ")";
                    font-size: 12px;
                    font-weight: 600;
                    horizontal-alignment: center;
                }

                Button {
                    text: "â–¶";
                    clicked => { next-page-clicked(); }
                    enabled: current-page < (total-pages - 1);
                }
            }

            // 5x2 Sample Grid
            VerticalBox {
                spacing: 6px;

                // Row 1: Slots 0-4 (relative to page)
                HorizontalLayout {
                    spacing: 6px;
                    alignment: center;
                    for i in [0, 1, 2, 3, 4]: SamplePad {
                        sample: samples[start-slot + i];
                        width: 130px;
                        height: 120px;
                        selected: selected-slot == samples[start-slot + i].slot;
                        upload-clicked => { upload-clicked(samples[start-slot + i].slot); }
                        download-clicked => { download-clicked(samples[start-slot + i].slot); }
                        delete-clicked => { delete-clicked(samples[start-slot + i].slot); }
                        pad-clicked => { pad-selected(samples[start-slot + i].slot); }
                    }
                }

                // Row 2: Slots 5-9 (relative to page)
                HorizontalLayout {
                    spacing: 6px;
                    alignment: center;
                    for i in [5, 6, 7, 8, 9]: SamplePad {
                        sample: samples[start-slot + i];
                        width: 130px;
                        height: 120px;
                        selected: selected-slot == samples[start-slot + i].slot;
                        upload-clicked => { upload-clicked(samples[start-slot + i].slot); }
                        download-clicked => { download-clicked(samples[start-slot + i].slot); }
                        delete-clicked => { delete-clicked(samples[start-slot + i].slot); }
                        pad-clicked => { pad-selected(samples[start-slot + i].slot); }
                    }
                }
            }

            // Waveform viewer - expands to fill available space
            WaveformView {
                vertical-stretch: 1;
                min-height: 150px;
                sample-name: selected-sample-name;
                sample-length: selected-sample-length;
                waveform-path: waveform-path;
                has-waveform: selected-slot >= 0;
                is-playing: is-playing;
                playback-position: playback-position;
                zoom-level <=> waveform-zoom;
                scroll-position <=> waveform-scroll;
                waveform-display-width <=> root.waveform-display-width;
                waveform-display-height <=> root.waveform-display-height;
                zoom-in => { waveform-zoom-in(); }
                zoom-out => { waveform-zoom-out(); }
                zoom-reset => { waveform-zoom-reset(); }
                regenerate-waveform(width, height) => { root.regenerate-waveform(width, height); }
            }

            // Playback controls
            HorizontalLayout {
                height: 32px;
                spacing: 8px;
                alignment: center;

                Button {
                    text: is-playing ? "â–¶ Playing..." : "â–¶ Play";
                    enabled: selected-slot >= 0 && !is-playing;
                    clicked => { play-clicked(); }
                }

                Button {
                    text: "â¹ Stop";
                    enabled: is-playing;
                    clicked => { stop-clicked(); }
                }
            }

            // Status bar
            HorizontalBox {
                height: 24px;
                spacing: 8px;

                Text {
                    text: "Samples: ? / 200";
                    font-size: 10px;
                    color: #666;
                    vertical-alignment: center;
                }

                Rectangle {
                    horizontal-stretch: 1;
                }

                Text {
                    text: scanning ? "Scanning..." : "Ready";
                    font-size: 10px;
                    color: #999;
                    vertical-alignment: center;
                }

                Button {
                    text: show-debug-log ? "Hide Log" : "Show Log";
                    clicked => { toggle-debug-log(); }
                }
            }

            // Debug log viewer (toggle with Cmd+D)
            if show-debug-log: Rectangle {
                height: 120px;
                border-width: 1px;
                border-color: #cccccc;
                border-radius: 4px;
                background: #1e1e1e;

                VerticalLayout {
                    padding: 8px;
                    spacing: 4px;

                    Text {
                        text: "Debug Log";
                        font-size: 10px;
                        font-weight: 700;
                        color: #00ff00;
                        height: 14px;
                    }

                    TextEdit {
                        text <=> log-text;
                        font-size: 9px;
                        read-only: true;
                        vertical-stretch: 1;
                    }
                }
            }
        }
    }
}
