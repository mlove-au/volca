import { Button, VerticalBox, HorizontalBox, ScrollView, GridBox, TextEdit } from "std-widgets.slint";

export struct SampleInfo {
    slot: int,
    name: string,
    length: int,
    has-sample: bool,
}

component SamplePad inherits Rectangle {
    in property <SampleInfo> sample;
    callback upload-clicked();
    callback download-clicked();
    callback play-clicked();
    callback delete-clicked();

    border-radius: 8px;
    border-width: 2px;
    border-color: sample.has-sample ? #4a90e2 : #cccccc;
    background: sample.has-sample ? #f0f8ff : #f9f9f9;

    VerticalBox {
        padding: 12px;
        spacing: 6px;

        // Slot number
        Text {
            text: sample.slot < 10 ? "00" + sample.slot : (sample.slot < 100 ? "0" + sample.slot : "" + sample.slot);
            font-size: 16px;
            font-weight: 700;
            color: #666;
            horizontal-alignment: center;
        }

        // Sample name or empty indicator
        Text {
            text: sample.has-sample ? sample.name : "(empty)";
            font-size: 16px;
            font-weight: sample.has-sample ? 600 : 400;
            color: sample.has-sample ? #333 : #999;
            overflow: elide;
            horizontal-alignment: center;
        }

        // Length display
        if sample.has-sample: Text {
            text: (sample.length / 31250) + "s";
            font-size: 13px;
            color: #666;
            horizontal-alignment: center;
        }

        // Spacer
        Rectangle {
            vertical-stretch: 1;
        }

        // Action buttons
        HorizontalLayout {
            spacing: 4px;

            if sample.has-sample: Button {
                text: "â–¶";
                clicked => { play-clicked(); }
            }

            if sample.has-sample: Button {
                text: "ðŸ’¾";
                clicked => { download-clicked(); }
            }

            if !sample.has-sample: Button {
                text: "â¬†";
                clicked => { upload-clicked(); }
            }

            if sample.has-sample: Button {
                text: "ðŸ—‘";
                clicked => { delete-clicked(); }
            }
        }
    }
}

export component AppWindow inherits Window {
    title: "Volca Sample 2 Manager";
    preferred-width: 1400px;
    preferred-height: 900px;

    callback connect-clicked();
    callback refresh-clicked();
    callback upload-clicked(int);
    callback download-clicked(int);
    callback play-clicked(int);
    callback delete-clicked(int);
    callback prev-page-clicked();
    callback next-page-clicked();

    in-out property <bool> connected: false;
    in-out property <[SampleInfo]> samples;
    in-out property <[string]> logs;
    in-out property <string> log-text;
    in-out property <int> current-page: 0;
    in-out property <int> total-pages: 10; // 200 slots / 20 per page = 10 pages
    in-out property <bool> scanning: false;

    // Calculate which samples to display (20 per page)
    property <int> start-slot: current-page * 20;

    VerticalBox {
        padding: 16px;
        spacing: 12px;

        // Connection bar
        HorizontalBox {
            height: 40px;
            spacing: 12px;

            Rectangle {
                width: 12px;
                height: 12px;
                border-radius: 6px;
                background: connected ? #4caf50 : #f44336;
            }

            Text {
                text: connected ? (scanning ? "Connected - Scanning..." : "Connected to Volca Sample 2") : "Not Connected";
                font-size: 16px;
                font-weight: 600;
                vertical-alignment: center;
            }

            Rectangle {
                horizontal-stretch: 1;
            }

            Button {
                text: connected ? "Disconnect" : "Connect Device";
                clicked => { connect-clicked(); }
                min-width: 150px;
            }

            Button {
                text: "Scan Samples";
                clicked => { refresh-clicked(); }
                enabled: connected && !scanning;
                min-width: 150px;
            }
        }

        // Page navigation
        HorizontalBox {
            height: 40px;
            spacing: 12px;
            alignment: center;

            Button {
                text: "â—€ Prev";
                clicked => { prev-page-clicked(); }
                enabled: current-page > 0;
                min-width: 100px;
            }

            Text {
                text: "Page " + (current-page + 1) + " / " + total-pages + "  (Slots " + start-slot + "-" + (start-slot + 19) + ")";
                font-size: 16px;
                font-weight: 600;
                horizontal-alignment: center;
            }

            Button {
                text: "Next â–¶";
                clicked => { next-page-clicked(); }
                enabled: current-page < (total-pages - 1);
                min-width: 100px;
            }
        }

        // 4x5 Sample Grid
        VerticalBox {
            spacing: 12px;
            padding: 8px;

            // Row 1: Slots 0-4 (relative to page)
            HorizontalLayout {
                spacing: 12px;
                for i in [0, 1, 2, 3, 4]: SamplePad {
                    sample: samples[start-slot + i];
                    width: 200px;
                    height: 160px;
                    upload-clicked => { upload-clicked(samples[start-slot + i].slot); }
                    download-clicked => { download-clicked(samples[start-slot + i].slot); }
                    play-clicked => { play-clicked(samples[start-slot + i].slot); }
                    delete-clicked => { delete-clicked(samples[start-slot + i].slot); }
                }
            }

            // Row 2: Slots 5-9 (relative to page)
            HorizontalLayout {
                spacing: 12px;
                for i in [5, 6, 7, 8, 9]: SamplePad {
                    sample: samples[start-slot + i];
                    width: 200px;
                    height: 160px;
                    upload-clicked => { upload-clicked(samples[start-slot + i].slot); }
                    download-clicked => { download-clicked(samples[start-slot + i].slot); }
                    play-clicked => { play-clicked(samples[start-slot + i].slot); }
                    delete-clicked => { delete-clicked(samples[start-slot + i].slot); }
                }
            }

            // Row 3: Slots 10-14 (relative to page)
            HorizontalLayout {
                spacing: 12px;
                for i in [10, 11, 12, 13, 14]: SamplePad {
                    sample: samples[start-slot + i];
                    width: 200px;
                    height: 160px;
                    upload-clicked => { upload-clicked(samples[start-slot + i].slot); }
                    download-clicked => { download-clicked(samples[start-slot + i].slot); }
                    play-clicked => { play-clicked(samples[start-slot + i].slot); }
                    delete-clicked => { delete-clicked(samples[start-slot + i].slot); }
                }
            }

            // Row 4: Slots 15-19 (relative to page)
            HorizontalLayout {
                spacing: 12px;
                for i in [15, 16, 17, 18, 19]: SamplePad {
                    sample: samples[start-slot + i];
                    width: 200px;
                    height: 160px;
                    upload-clicked => { upload-clicked(samples[start-slot + i].slot); }
                    download-clicked => { download-clicked(samples[start-slot + i].slot); }
                    play-clicked => { play-clicked(samples[start-slot + i].slot); }
                    delete-clicked => { delete-clicked(samples[start-slot + i].slot); }
                }
            }
        }

        // Status bar
        HorizontalBox {
            height: 30px;
            spacing: 12px;

            Text {
                text: "Samples: ? / 200";
                font-size: 12px;
                color: #666;
                vertical-alignment: center;
            }

            Rectangle {
                horizontal-stretch: 1;
            }

            Text {
                text: scanning ? "Status: Scanning..." : "Status: Ready";
                font-size: 12px;
                color: #999;
                vertical-alignment: center;
            }
        }

        // Debug log viewer
        Rectangle {
            height: 150px;
            border-width: 1px;
            border-color: #cccccc;
            border-radius: 4px;
            background: #1e1e1e;

            VerticalBox {
                padding: 8px;

                Text {
                    text: "Debug Log";
                    font-size: 11px;
                    font-weight: 700;
                    color: #00ff00;
                }

                TextEdit {
                    text <=> log-text;
                    font-size: 10px;
                    wrap: word-wrap;
                    height: 120px;
                }
            }
        }
    }
}
